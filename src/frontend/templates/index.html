<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ML Inference Dashboard</title>
    <link rel="stylesheet" href="/static/css/compact.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
    <div class="dashboard">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <h1>ML Inference Dashboard</h1>
                <div class="header-badges">
                    <span class="badge" id="badge_backend">Backend</span>
                    <span class="badge" id="badge_device">Device</span>
                    <span class="badge status" id="status">Ready</span>
                </div>
            </div>
        </header>

        <main class="main-content">
            <!-- Top Row: Key Metrics -->
            <section class="metrics-grid">
                <div class="metric">
                    <div class="metric-label">Queries</div>
                    <div class="metric-value" id="query_count">0</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Latency</div>
                    <div class="metric-value" id="instant_latency_ms">0</div>
                    <div class="metric-unit">ms</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Throughput</div>
                    <div class="metric-value" id="throughput_qps">0</div>
                    <div class="metric-unit">q/s</div>
                </div>
                <div class="metric">
                    <div class="metric-label">CPU</div>
                    <div class="metric-value" id="cpu_live">0%</div>
                </div>
                <div class="metric">
                    <div class="metric-label">GPU Memory</div>
                    <div class="metric-value" id="gpu_live">0</div>
                    <div class="metric-unit">MB</div>
                </div>
            </section>

            <!-- Stage Breakdown -->
            <section class="stage-section">
                <h3>Stage Breakdown</h3>
                <div class="stage-bar">
                    <div class="stage-segment tokenize" id="bar_tokenize" style="width: 0%"></div>
                    <div class="stage-segment tokenizer-queue" id="bar_tokenizer_queue_wait" style="width: 0%"></div>
                    <div class="stage-segment model-queue" id="bar_model_queue_wait" style="width: 0%"></div>
                    <div class="stage-segment inference" id="bar_inference" style="width: 0%"></div>
                    <div class="stage-segment overhead" id="bar_overhead" style="width: 0%"></div>
                </div>
                <div class="stage-legend">
                    <span><span class="legend-dot tokenize"></span>Tokenize: <span id="pct_tokenize">0</span>%</span>
                    <span><span class="legend-dot tokenizer-queue"></span>TQ Wait: <span id="pct_tokenizer_queue_wait">0</span>%</span>
                    <span><span class="legend-dot model-queue"></span>MQ Wait: <span id="pct_model_queue_wait">0</span>%</span>
                    <span><span class="legend-dot inference"></span>Inference: <span id="pct_inference">0</span>%</span>
                    <span><span class="legend-dot overhead"></span>Overhead: <span id="pct_overhead">0</span>%</span>
                </div>
            </section>

            <!-- Tokenization & Inference Metrics -->
            <section class="pipeline-grid">
                <div class="pipeline-card">
                    <h4>Tokenization</h4>
                    <div class="card-metrics">
                        <div class="card-metric">
                            <span class="label">Latency</span>
                            <span class="value" id="tokenize_ms">0</span>
                            <span class="unit">ms</span>
                        </div>
                        <div class="card-metric">
                            <span class="label">Queue Wait</span>
                            <span class="value" id="tokenizer_queue_wait_ms">0</span>
                            <span class="unit">ms</span>
                        </div>
                        <div class="card-metric">
                            <span class="label">Queue Size</span>
                            <span class="value" id="tokenizer_queue_size">0</span>
                        </div>
                        <div class="card-metric">
                            <span class="label">Throughput</span>
                            <span class="value" id="tokenizer_throughput_qps">0</span>
                            <span class="unit">q/s</span>
                        </div>
                    </div>
                </div>

                <div class="pipeline-card">
                    <h4>Inference</h4>
                    <div class="card-metrics">
                        <div class="card-metric">
                            <span class="label">Latency</span>
                            <span class="value" id="inference_ms">0</span>
                            <span class="unit">ms</span>
                        </div>
                        <div class="card-metric">
                            <span class="label">Queue Wait</span>
                            <span class="value" id="model_queue_wait_ms">0</span>
                            <span class="unit">ms</span>
                        </div>
                        <div class="card-metric">
                            <span class="label">Queue Size</span>
                            <span class="value" id="model_queue_size">0</span>
                        </div>
                        <div class="card-metric">
                            <span class="label">Throughput</span>
                            <span class="value" id="inference_throughput_qps">0</span>
                            <span class="unit">q/s</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Charts Grid (2x3) -->
            <section class="charts-grid">
                <div class="chart-small">
                    <div class="chart-title">Latency</div>
                    <canvas id="latencyChart" width="200" height="80"></canvas>
                </div>
                <div class="chart-small">
                    <div class="chart-title">Throughput</div>
                    <canvas id="throughputChart" width="200" height="80"></canvas>
                </div>
                <div class="chart-small">
                    <div class="chart-title">CPU</div>
                    <canvas id="cpuChart" width="200" height="80"></canvas>
                </div>
                <div class="chart-small">
                    <div class="chart-title">GPU Memory</div>
                    <canvas id="gpuChart" width="200" height="80"></canvas>
                </div>
                <div class="chart-small">
                    <div class="chart-title">Queries</div>
                    <canvas id="queriesChart" width="200" height="80"></canvas>
                </div>
                <div class="chart-small">
                    <div class="chart-title">Padding Waste</div>
                    <canvas id="paddingChart" width="200" height="80"></canvas>
                </div>
            </section>

            <!-- Worker Stats (if available) -->
            <section id="worker-section" style="display: none;" class="worker-section">
                <h3>Model Worker Statistics</h3>
                <div class="worker-grid" id="worker_stats_section"></div>
            </section>

            <section id="tokenizer-worker-section" style="display: none;" class="worker-section">
                <h3>Tokenizer Worker Statistics</h3>
                <div class="worker-grid" id="tokenizer_worker_stats_section"></div>
            </section>

            <!-- Tokenization Detail Charts -->
            <section class="detail-section">
                <h3>Tokenization Details</h3>
                <div class="detail-charts-grid">
                    <div class="chart-small">
                        <div class="chart-title">Tokenize Latency</div>
                        <canvas id="tokenizeChart" width="200" height="80"></canvas>
                    </div>
                    <div class="chart-small">
                        <div class="chart-title">TQ Wait</div>
                        <canvas id="tokenizerQueueWaitChart" width="200" height="80"></canvas>
                    </div>
                    <div class="chart-small">
                        <div class="chart-title">TQ Size</div>
                        <canvas id="tokenizerQueueSizeChart" width="200" height="80"></canvas>
                    </div>
                    <div class="chart-small">
                        <div class="chart-title">T Throughput</div>
                        <canvas id="tokenizerThroughputChart" width="200" height="80"></canvas>
                    </div>
                    <div class="chart-small">
                        <div class="chart-title">Overhead</div>
                        <canvas id="overheadChart" width="200" height="80"></canvas>
                    </div>
                </div>
            </section>

            <!-- Inference Detail Charts -->
            <section class="detail-section">
                <h3>Inference Details</h3>
                <div class="detail-charts-grid">
                    <div class="chart-small">
                        <div class="chart-title">Inference Latency</div>
                        <canvas id="inferenceChart" width="200" height="80"></canvas>
                    </div>
                    <div class="chart-small">
                        <div class="chart-title">MQ Wait</div>
                        <canvas id="modelQueueWaitChart" width="200" height="80"></canvas>
                    </div>
                    <div class="chart-small">
                        <div class="chart-title">MQ Size</div>
                        <canvas id="modelQueueSizeChart" width="200" height="80"></canvas>
                    </div>
                    <div class="chart-small">
                        <div class="chart-title">I Throughput</div>
                        <canvas id="inferenceThroughputChart" width="200" height="80"></canvas>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Hidden elements for backward compatibility -->
    <div style="display: none;">
        <div id="experiment_name">ML Inference Dashboard</div>
        <div id="experiment_subtitle">Real-time Monitor</div>
        <div id="tokenize_live">0 ms</div>
        <div id="tokenizer_queue_wait_live">0 ms</div>
        <div id="tokenizer_queue_size_live">0</div>
        <div id="inference_live">0 ms</div>
        <div id="model_queue_wait_live">0 ms</div>
        <div id="model_queue_size_live">0</div>
        <div id="overhead_ms">0</div>
        <div id="overhead_live">0 ms</div>
        <div id="padding_pct">0</div>
        <div id="max_seq_len">0</div>
        <div id="avg_seq_len">0</div>
        <div id="padding_live">0%</div>
        <div id="utilization_live">0%</div>
        <div id="latency_live">0 ms</div>
        <div id="throughput_live">0 q/s</div>
        <div id="queries_live">0</div>
        <div id="tokenize_p95_card">0</div>
        <div id="tokenizer_queue_wait_p95_card">0</div>
        <div id="inference_p95_card">0</div>
        <div id="model_queue_wait_p95_card">0</div>
        <div id="tokenize_p95">0 ms</div>
        <div id="tokenizer_queue_wait_p95_breakdown">0 ms</div>
        <div id="model_queue_wait_p95_breakdown">0 ms</div>
        <div id="inference_p95">0 ms</div>
        <div id="total_p95">0 ms</div>
        <div id="pct_mp_queue_send">0</div>
        <div id="pct_mp_queue_receive">0</div>
        <div id="pct_grpc_serialize">0</div>
        <div id="pct_grpc_deserialize">0</div>
        <div id="pct_scheduler">0</div>
        <div id="pct_other">0</div>
        <div id="bar_mp_queue_send"></div>
        <div id="bar_mp_queue_receive"></div>
        <div id="bar_grpc_serialize"></div>
        <div id="bar_grpc_deserialize"></div>
        <div id="bar_scheduler"></div>
        <div id="bar_other"></div>
        <div id="bar_queue_wait"></div>
        <div id="instance_section_title"></div>
        <div id="instance_metrics"></div>
        <div id="worker_stats_title"></div>
        <div id="tokenizer_worker_stats_title"></div>
        <div id="pipeline_section_title"></div>
        <div id="pipeline_throughput_section"></div>
        <div id="overall_throughput_live"></div>
        <div id="tokenizer_throughput_live"></div>
        <div id="inference_throughput_live"></div>
        <div id="instance_charts_title"></div>
        <div id="instance_charts"></div>
        <div id="worker_stats_section"></div>
        <div id="tokenizer_worker_stats_section"></div>
        <div id="queue_wait_ms"></div>
        <div id="queue_wait_p95"></div>
        <div id="queue_wait_p95_breakdown"></div>
    </div>

    <script src="/static/js/charts.js?v=2"></script>
    <script src="/static/js/main.js?v=9"></script>
</body>
</html>
