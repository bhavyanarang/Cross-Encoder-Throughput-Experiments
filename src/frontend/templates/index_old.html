<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ML Inference Dashboard</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <h1 id="experiment_name">ML Inference Dashboard</h1>
        <div class="subtitle" id="experiment_subtitle">Real-time Performance Monitor</div>
        <div class="experiment-info">
            <span class="badge backend" id="badge_backend">Backend</span>
            <span class="badge device" id="badge_device">Device</span>
            <span class="badge status" id="status">Ready</span>
        </div>
    </header>

    <!-- Overall Metrics -->
    <section class="metrics-row">
        <div class="metric-card">
            <div class="metric-label">Queries</div>
            <div class="metric-value" id="query_count">0</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Total Latency</div>
            <div class="metric-value" id="instant_latency_ms">0</div>
            <div class="metric-unit">ms</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Overall Throughput</div>
            <div class="metric-value" id="throughput_qps">0</div>
            <div class="metric-unit">q/s</div>
        </div>
    </section>

    <!-- Tokenization Section -->
    <div class="section-title">Tokenization</div>
    <section class="pipeline-section tokenization-section">
        <div class="metrics-row">
            <div class="metric-card highlight">
                <div class="metric-label">Tokenization Latency</div>
                <div class="metric-value" id="tokenize_ms">0</div>
                <div class="metric-unit">ms</div>
            </div>
            <div class="metric-card tokenizer-queue-wait">
                <div class="metric-label">Queue Wait</div>
                <div class="metric-value" id="tokenizer_queue_wait_ms">0</div>
                <div class="metric-unit">ms</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Queue Size</div>
                <div class="metric-value" id="tokenizer_queue_size">0</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Throughput</div>
                <div class="metric-value" id="tokenizer_throughput_qps">0</div>
                <div class="metric-unit">q/s</div>
            </div>
            <div class="metric-card overhead">
                <div class="metric-label">Overhead</div>
                <div class="metric-value" id="overhead_ms">0</div>
                <div class="metric-unit">ms</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">P95 Latency</div>
                <div class="metric-value" id="tokenize_p95_card">0</div>
                <div class="metric-unit">ms</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Queue Wait P95</div>
                <div class="metric-value" id="tokenizer_queue_wait_p95_card">0</div>
                <div class="metric-unit">ms</div>
            </div>
        </div>

        <div class="chart-grid three-col">
            <div class="chart-container">
                <div class="chart-header">
                    <span class="chart-title">Tokenization Latency</span>
                    <span class="chart-value tokenize" id="tokenize_live">0 ms</span>
                </div>
                <div class="chart-wrapper">
                    <canvas id="tokenizeChart" width="400" height="120"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-header">
                    <span class="chart-title">Queue Wait</span>
                    <span class="chart-value tokenizer-queue" id="tokenizer_queue_wait_live">0 ms</span>
                </div>
                <div class="chart-wrapper">
                    <canvas id="tokenizerQueueWaitChart" width="400" height="200"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-header">
                    <span class="chart-title">Queue Size</span>
                    <span class="chart-value" id="tokenizer_queue_size_live">0</span>
                </div>
                <div class="chart-wrapper">
                    <canvas id="tokenizerQueueSizeChart" width="400" height="200"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-header">
                    <span class="chart-title">Throughput</span>
                    <span class="chart-value" id="tokenizer_throughput_live">0 q/s</span>
                </div>
                <div class="chart-wrapper">
                    <canvas id="tokenizerThroughputChart" width="400" height="200"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-header">
                    <span class="chart-title">Overhead</span>
                    <span class="chart-value overhead" id="overhead_live">0 ms</span>
                </div>
                <div class="chart-wrapper">
                    <canvas id="overheadChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
    </section>

    <!-- Inference Section -->
    <div class="section-title">Inference</div>
    <section class="pipeline-section inference-section">
        <div class="metrics-row">
            <div class="metric-card inference">
                <div class="metric-label">Inference Latency</div>
                <div class="metric-value" id="inference_ms">0</div>
                <div class="metric-unit">ms</div>
            </div>
            <div class="metric-card model-queue-wait">
                <div class="metric-label">Queue Wait</div>
                <div class="metric-value" id="model_queue_wait_ms">0</div>
                <div class="metric-unit">ms</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Queue Size</div>
                <div class="metric-value" id="model_queue_size">0</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Throughput</div>
                <div class="metric-value" id="inference_throughput_qps">0</div>
                <div class="metric-unit">q/s</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">P95 Latency</div>
                <div class="metric-value" id="inference_p95_card">0</div>
                <div class="metric-unit">ms</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Queue Wait P95</div>
                <div class="metric-value" id="model_queue_wait_p95_card">0</div>
                <div class="metric-unit">ms</div>
            </div>
        </div>

        <div class="chart-grid three-col">
            <div class="chart-container">
                <div class="chart-header">
                    <span class="chart-title">Inference Latency</span>
                    <span class="chart-value inference" id="inference_live">0 ms</span>
                </div>
                <div class="chart-wrapper">
                    <canvas id="inferenceChart" width="400" height="200"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-header">
                    <span class="chart-title">Queue Wait</span>
                    <span class="chart-value model-queue" id="model_queue_wait_live">0 ms</span>
                </div>
                <div class="chart-wrapper">
                    <canvas id="modelQueueWaitChart" width="400" height="200"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-header">
                    <span class="chart-title">Queue Size</span>
                    <span class="chart-value" id="model_queue_size_live">0</span>
                </div>
                <div class="chart-wrapper">
                    <canvas id="modelQueueSizeChart" width="400" height="200"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-header">
                    <span class="chart-title">Throughput</span>
                    <span class="chart-value" id="inference_throughput_live">0 q/s</span>
                </div>
                <div class="chart-wrapper">
                    <canvas id="inferenceThroughputChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
    </section>

    <!-- Padding Analysis -->
    <section class="metrics-row padding-analysis">
        <div class="metric-card padding">
            <div class="metric-label">Padding Waste</div>
            <div class="metric-value" id="padding_pct">0</div>
            <div class="metric-unit">%</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Max Seq Len</div>
            <div class="metric-value" id="max_seq_len">0</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Avg Seq Len</div>
            <div class="metric-value" id="avg_seq_len">0</div>
        </div>
    </section>

    <!-- Model Instance Metrics -->
    <div class="section-title" id="instance_section_title" style="display: none;">Model Instances</div>
    <section class="metrics-row instance-metrics" id="instance_metrics" style="display: none;">
        <!-- Dynamically populated with per-instance cards -->
    </section>

    <!-- Stage Breakdown -->
    <div class="section-title">Stage Breakdown</div>
    <section class="stage-breakdown">
        <div class="stage-bar">
            <div class="stage-bar-segment tokenize" id="bar_tokenize" style="width: 0%"></div>
            <div class="stage-bar-segment tokenizer-queue-wait" id="bar_tokenizer_queue_wait" style="width: 0%"></div>
            <div class="stage-bar-segment model-queue-wait" id="bar_model_queue_wait" style="width: 0%"></div>
            <div class="stage-bar-segment queue-wait" id="bar_queue_wait" style="width: 0%; display: none;"></div>
            <div class="stage-bar-segment inference" id="bar_inference" style="width: 0%"></div>
            <div class="stage-bar-segment overhead" id="bar_overhead" style="width: 0%"></div>
            <div class="stage-bar-segment mp-queue-send" id="bar_mp_queue_send" style="width: 0%"></div>
            <div class="stage-bar-segment mp-queue-receive" id="bar_mp_queue_receive" style="width: 0%"></div>
            <div class="stage-bar-segment grpc-serialize" id="bar_grpc_serialize" style="width: 0%"></div>
            <div class="stage-bar-segment grpc-deserialize" id="bar_grpc_deserialize" style="width: 0%"></div>
            <div class="stage-bar-segment scheduler" id="bar_scheduler" style="width: 0%"></div>
            <div class="stage-bar-segment other" id="bar_other" style="width: 0%"></div>
        </div>
        <div class="stage-legend">
            <div class="legend-item" data-component="tokenize">
                <div class="legend-dot tokenize"></div>
                <span>Tokenization (<span id="pct_tokenize">0</span>%)</span>
            </div>
            <div class="legend-item" data-component="tokenizer_queue_wait">
                <div class="legend-dot tokenizer-queue-wait"></div>
                <span>Tokenizer Queue Wait (<span id="pct_tokenizer_queue_wait">0</span>%)</span>
            </div>
            <div class="legend-item" data-component="model_queue_wait">
                <div class="legend-dot model-queue-wait"></div>
                <span>Model Queue Wait (<span id="pct_model_queue_wait">0</span>%)</span>
            </div>
            <div class="legend-item" data-component="queue_wait" style="display: none;">
                <div class="legend-dot queue-wait"></div>
                <span>Queue Wait (<span id="pct_queue_wait">0</span>%)</span>
            </div>
            <div class="legend-item" data-component="inference">
                <div class="legend-dot inference"></div>
                <span>Model Inference (<span id="pct_inference">0</span>%)</span>
            </div>
            <div class="legend-item" data-component="overhead">
                <div class="legend-dot overhead"></div>
                <span>Tokenizer Overhead (<span id="pct_overhead">0</span>%)</span>
            </div>
            <div class="legend-item" data-component="mp_queue_send">
                <div class="legend-dot mp-queue-send"></div>
                <span>MP Queue Send (<span id="pct_mp_queue_send">0</span>%)</span>
            </div>
            <div class="legend-item" data-component="mp_queue_receive">
                <div class="legend-dot mp-queue-receive"></div>
                <span>MP Queue Receive (<span id="pct_mp_queue_receive">0</span>%)</span>
            </div>
            <div class="legend-item" data-component="grpc_serialize">
                <div class="legend-dot grpc-serialize"></div>
                <span>gRPC Serialize (<span id="pct_grpc_serialize">0</span>%)</span>
            </div>
            <div class="legend-item" data-component="grpc_deserialize">
                <div class="legend-dot grpc-deserialize"></div>
                <span>gRPC Deserialize (<span id="pct_grpc_deserialize">0</span>%)</span>
            </div>
            <div class="legend-item" data-component="scheduler">
                <div class="legend-dot scheduler"></div>
                <span>Scheduler (<span id="pct_scheduler">0</span>%)</span>
            </div>
            <div class="legend-item" data-component="other">
                <div class="legend-dot other"></div>
                <span>Other (<span id="pct_other">0</span>%)</span>
            </div>
        </div>
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-label">Tokenize P95</div>
                <div class="stat-value" id="tokenize_p95">0 ms</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Tokenizer Queue Wait P95</div>
                <div class="stat-value" id="tokenizer_queue_wait_p95_breakdown">0 ms</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Model Queue Wait P95</div>
                <div class="stat-value" id="model_queue_wait_p95_breakdown">0 ms</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Inference P95</div>
                <div class="stat-value" id="inference_p95">0 ms</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Total P95</div>
                <div class="stat-value" id="total_p95">0 ms</div>
            </div>
        </div>
    </section>

    <!-- Per-Worker/Per-Model Stats (for multi-model experiments) -->
    <div class="section-title" id="worker_stats_title" style="display: none;">Model Worker Statistics</div>
    <section class="metrics-row worker-stats" id="worker_stats_section" style="display: none;">
        <!-- Dynamically populated with per-worker/per-model stats -->
    </section>

    <div class="section-title" id="tokenizer_worker_stats_title" style="display: none;">Tokenizer Worker Statistics</div>
    <section class="metrics-row worker-stats" id="tokenizer_worker_stats_section" style="display: none;">
        <!-- Dynamically populated with per-tokenizer-worker stats -->
    </section>

    <!-- Charts Grid -->
    <div class="section-title">Performance Charts</div>
    <main class="charts-container">
        <!-- Row 1: Main metrics -->
        <div class="chart-grid">
            <div class="chart-container">
                <div class="chart-header">
                    <span class="chart-title">Total Latency</span>
                    <span class="chart-value" id="latency_live">0 ms</span>
                </div>
                <div class="chart-wrapper">
                    <canvas id="latencyChart" width="400" height="200"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-header">
                    <span class="chart-title">Throughput</span>
                    <span class="chart-value" id="throughput_live">0 q/s</span>
                </div>
                <div class="chart-wrapper">
                    <canvas id="throughputChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>


        <!-- Row 3: System metrics -->
        <div class="chart-grid three-col">
            <div class="chart-container">
                <div class="chart-header">
                    <span class="chart-title">CPU Usage</span>
                    <span class="chart-value cpu" id="cpu_live">0%</span>
                </div>
                <div class="chart-wrapper">
                    <canvas id="cpuChart" width="400" height="200"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-header">
                    <span class="chart-title">GPU Memory</span>
                    <span class="chart-value gpu" id="gpu_live">0 MB</span>
                </div>
                <div class="chart-wrapper">
                    <canvas id="gpuChart" width="400" height="200"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-header">
                    <span class="chart-title">Queries Processed</span>
                    <span class="chart-value" id="queries_live">0</span>
                </div>
                <div class="chart-wrapper">
                    <canvas id="queriesChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>

        <!-- Row 4: Padding Waste Chart -->
        <div class="section-title">Padding Analysis</div>
        <div class="chart-grid">
            <div class="chart-container">
                <div class="chart-header">
                    <span class="chart-title">Padding Waste</span>
                    <span class="chart-value padding" id="padding_live">0%</span>
                </div>
                <div class="chart-wrapper">
                    <canvas id="paddingChart" width="400" height="200"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-header">
                    <span class="chart-title">Avg Utilization</span>
                    <span class="chart-value" id="utilization_live">0%</span>
                </div>
                <div class="chart-wrapper">
                    <canvas id="utilizationChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>

        <!-- Row 5: Per-Instance Utilization Charts (multi-model mode) -->
        <div class="section-title" id="instance_charts_title" style="display: none;">Per-Instance Metrics</div>
        <div class="chart-grid instance-charts" id="instance_charts" style="display: none;">
            <!-- Dynamically populated with per-instance utilization charts -->
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        ML Inference Server - Stage Timing Dashboard
    </footer>

    <!-- Scripts -->
    <script src="/static/js/charts.js?v=2"></script>
    <script src="/static/js/main.js?v=8"></script>
    <script>
        // Immediate test - runs as soon as this script tag executes
        console.log('[inline] Inline script executed');
        window.addEventListener('load', function() {
            console.log('[inline] Window load event fired');
            // Force update test
            setTimeout(function() {
                const el = document.getElementById('query_count');
                if (el) {
                    console.log('[inline] ✅ Found query_count, current value:', el.textContent);
                    el.style.border = '2px solid red'; // Visual indicator
                } else {
                    console.error('[inline] ❌ query_count not found!');
                }
            }, 1000);
        });
    </script>
</body>
</html>
